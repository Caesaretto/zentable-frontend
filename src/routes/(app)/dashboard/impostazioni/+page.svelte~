<script>
  import { supabase } from '$lib/supabaseClient';
  import { onMount } from 'svelte';

  let loading = true;
  let userEmail = '';
  let restaurant = {
    nome: '',
    indirizzo: '',
    telefono: '',
    nome_proprietario: '',
    cognome_proprietario: ''
  };
  let message = '';

  onMount(async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      userEmail = user.email;
      const { data } = await supabase
        .from('ristoranti')
        .select()
        .eq('user_id', user.id)
        .single();
      if (data) {
        restaurant = data;
      }
    }
    loading = false;
  });

  async function handleSave() {
    loading = true;
    const { data: { user } } = await supabase.auth.getUser();
    const { error } = await supabase.from('ristoranti').upsert({
      id: restaurant.id,
      user_id: user.id,
      nome: restaurant.nome,
      indirizzo: restaurant.indirizzo,
      telefono: restaurant.telefono,
      nome_proprietario: restaurant.nome_proprietario,
      cognome_proprietario: restaurant.cognome_proprietario
    });

    if (error) {
      message = 'Errore: ' + error.message;
    } else {
      message = 'Dati salvati con successo!';
    }
    loading = false;
  }
</script>

<main class="container">
  <article>
    <a href="/dashboard">
      <img src="/logo.png" alt="Logo Zentable" class="logo">
    </a>
    <hgroup>
      <h1>Impostazioni</h1>
      <h2>Gestisci le informazioni del tuo locale e del tuo profilo.</h2>
    </hgroup>
    
    {#if loading}
      <p aria-busy="true">Caricamento...</p>
    {:else}
      <form on:submit|preventDefault={handleSave}>
        
        <fieldset class="form-grid">
          <label>
            Il Tuo Nome
            <input type="text" name="nome_proprietario" placeholder="Mario" bind:value={restaurant.nome_proprietario}>
          </label>
          <label>
            Il Tuo Cognome
            <input type="text" name="cognome_proprietario" placeholder="Rossi" bind:value={restaurant.cognome_proprietario}>
          </label>
        </fieldset>
        
        <hr>
        
        <label for="nome_ristorante">Nome Ristorante</label>
        <input type="text" id="nome_ristorante" name="nome_ristorante" placeholder="Nome del locale" bind:value={restaurant.nome} required>
        
        <fieldset class="form-grid">
            <label>
                Indirizzo
                <input type="text" name="indirizzo" placeholder="Indirizzo del locale" bind:value={restaurant.indirizzo}>
            </label>
            <label>
                Telefono
                <input type="tel" name="telefono" placeholder="Telefono del locale" bind:value={restaurant.telefono}>
            </label>
        </fieldset>

        <label for="email">Email Account</label>
        <input type="email" id="email" name="email" value={userEmail} disabled>

        <button type="submit" class="contrast" disabled={loading}>
          {loading ? 'Salvataggio...' : 'Salva'}
        </button>
      </form>
    {/if}

    {#if message}
      <p>{message}</p>
    {/if}
  </article>
</main>

<style>
  main {
    display: grid;
    place-items: center;
    min-height: 100svh;
    padding: 2rem 1rem;
    box-sizing: border-box;
  }
  article {
    width: 100%;
    max-width: 600px;
    margin: 0;
    padding: 1.5rem; /* Padding ridotto */
  }
  .logo {
      display: block;
      margin: 0 auto 1rem;
      width: 100px;
  }
  hgroup {
      margin-bottom: 2rem; /* Margine aumentato */
  }
  h2 {
    font-weight: 300;
    color: var(--muted-color);
    font-size: 1rem;
  }
  .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
  }
  /* Stile per il pulsante Salva */
  button {
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      background-color: var(--primary);
      border-color: var(--primary);
  }
  button:hover {
      background-color: var(--primary-hover);
      border-color: var(--primary-hover);
  }

  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
